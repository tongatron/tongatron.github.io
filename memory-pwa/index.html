<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La Mia PWA</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    main {
      flex: 1;
      padding: 20px;
    }

    footer {
      height: 50px;
      background: #111;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-size: 14px;
    }

    .version {
      opacity: 0.7;
    }
  </style>
</head>

<body>

<main>
  <h1>La Mia PWA</h1>
  <p>Applicazione installabile su Android.</p>
</main>

<footer>
  <div>© 2026</div>
  <div class="version" id="appVersion">
    Versione: ...
  </div>
</footer>

<script>
  // Registrazione Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(reg => {
        console.log("SW registrato");
      });
  }

  // Richiesta versione al Service Worker
  function requestVersion() {
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: "GET_VERSION"
      });
    }
  }

  navigator.serviceWorker.addEventListener("message", (event) => {
    if (event.data && event.data.type === "VERSION") {
      document.getElementById("appVersion").textContent =
        "Versione: " + event.data.version;
    }
  });

  // Aspetta che SW sia pronto
  navigator.serviceWorker.ready.then(() => {
    requestVersion();
  });
</script>

</body>
</html>


<script>
if ("serviceWorker" in navigator) {

  navigator.serviceWorker.register("sw.js").then(reg => {

    // Se c'è già un SW in waiting
    if (reg.waiting) {
      showUpdateButton(reg.waiting);
    }

    reg.addEventListener("updatefound", () => {
      const newWorker = reg.installing;

      newWorker.addEventListener("statechange", () => {
        if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
          showUpdateButton(newWorker);
        }
      });
    });

  });

  navigator.serviceWorker.addEventListener("message", (event) => {
    if (event.data && event.data.type === "VERSION") {
      document.getElementById("appVersion").textContent =
        "Versione: " + event.data.version;
    }
  });
}

function showUpdateButton(worker) {
  const button = document.createElement("button");
  button.textContent = "Aggiornamento disponibile";
  button.style.position = "fixed";
  button.style.bottom = "70px";
  button.style.right = "20px";
  button.style.padding = "10px";
  button.style.background = "#ff9800";
  button.style.color = "white";
  button.style.border = "none";
  button.style.borderRadius = "5px";
  button.style.cursor = "pointer";
  button.style.zIndex = "9999";

  button.onclick = () => {
    worker.postMessage({ type: "SKIP_WAITING" });
    window.location.reload();
  };

  document.body.appendChild(button);
}
</script>
