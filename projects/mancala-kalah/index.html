<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mancala (Kalah)</title>
  <meta name="description" content="Gioco classico Mancala/Kalah: versione semplice browser con modalita contro CPU.">
  <style>
    :root {
      --bg: #f5f3ee;
      --panel: #fffdf8;
      --line: #b7a98a;
      --text: #2b2520;
      --muted: #6f6458;
      --wood: #d5bc96;
      --wood-dark: #ba9f77;
      --seed: #5a3f2a;
      --accent: #7a5b3f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(1000px 400px at 50% -10%, #ffffff, var(--bg));
      color: var(--text);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      min-height: 100vh;
    }

    .page {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 12px 28px;
      display: grid;
      gap: 12px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: clamp(28px, 6vw, 44px);
      line-height: 1.08;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
    }

    .meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .pill {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 700;
    }

    .btn:hover { border-color: var(--accent); }

    .board-wrap {
      overflow-x: auto;
    }

    .board {
      min-width: 760px;
      background: linear-gradient(180deg, var(--wood) 0%, var(--wood-dark) 100%);
      border: 1px solid #9a825d;
      border-radius: 16px;
      padding: 12px;
      display: grid;
      grid-template-columns: 82px 1fr 82px;
      gap: 10px;
      align-items: stretch;
    }

    .store {
      border: 2px solid #8b7350;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.38);
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: 800;
      color: #3b2e1f;
      min-height: 208px;
    }

    .rows {
      display: grid;
      gap: 10px;
      align-content: center;
    }

    .pit-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .pit {
      border: 2px solid #8b7350;
      border-radius: 14px;
      min-height: 94px;
      background: rgba(255, 255, 255, 0.35);
      color: #2d2419;
      font-size: 27px;
      font-weight: 800;
      cursor: pointer;
      position: relative;
      transition: transform 90ms ease, box-shadow 90ms ease;
    }

    .pit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 0 rgba(74, 57, 34, 0.35);
    }

    .pit:disabled {
      cursor: not-allowed;
      opacity: 0.65;
    }

    .pit.active {
      outline: 3px solid #fff2c8;
    }

    .pit .label {
      position: absolute;
      bottom: 6px;
      left: 8px;
      font-size: 11px;
      color: #4a3c2c;
      opacity: 0.75;
      font-weight: 600;
    }

    .status {
      margin: 0;
      min-height: 24px;
      font-weight: 700;
    }

    .rules {
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
      font-size: 14px;
    }

    .winner {
      color: #14532d;
    }

    @media (max-width: 760px) {
      .board {
        min-width: 640px;
      }

      .pit {
        min-height: 82px;
        font-size: 24px;
      }

      .store {
        min-height: 182px;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <section class="panel">
      <h1>Mancala (Kalah)</h1>
      <p class="subtitle">
        Gioco tradizionale della famiglia Mancala, diffuso in Africa e Medio Oriente.
        Versione semplice: scegli una buca del tuo lato e semina i semi in senso orario.
      </p>
      <div class="meta">
        <span class="pill">Tu: lato basso</span>
        <span class="pill">CPU: lato alto</span>
        <span class="pill">4 semi per buca</span>
      </div>
    </section>

    <section class="panel controls">
      <button id="newGame" class="btn" type="button">Nuova partita</button>
      <label>
        <input id="cpuToggle" type="checkbox" checked>
        Gioca contro CPU
      </label>
    </section>

    <section class="panel board-wrap">
      <div class="board" aria-label="Tavolo Mancala">
        <div id="storeCpu" class="store" aria-label="Magazzino CPU">0</div>
        <div class="rows">
          <div id="rowCpu" class="pit-row" aria-label="Buche CPU"></div>
          <div id="rowPlayer" class="pit-row" aria-label="Buche giocatore"></div>
        </div>
        <div id="storePlayer" class="store" aria-label="Magazzino giocatore">0</div>
      </div>
    </section>

    <section class="panel">
      <p id="status" class="status">Tocca una tua buca per iniziare.</p>
      <p class="rules">
        Regole base: se l'ultimo seme finisce nel tuo magazzino giochi di nuovo.
        Se finisce in una tua buca vuota e la buca opposta ha semi, li catturi.
      </p>
    </section>
  </main>

  <script>
    const PITS_PER_SIDE = 6;
    const INITIAL_SEEDS = 4;

    const rowCpu = document.getElementById("rowCpu");
    const rowPlayer = document.getElementById("rowPlayer");
    const storeCpu = document.getElementById("storeCpu");
    const storePlayer = document.getElementById("storePlayer");
    const statusEl = document.getElementById("status");
    const newGameBtn = document.getElementById("newGame");
    const cpuToggle = document.getElementById("cpuToggle");

    let board = [];
    let current = "player";
    let ended = false;

    function resetBoard() {
      board = [
        ...Array(PITS_PER_SIDE).fill(INITIAL_SEEDS),
        0,
        ...Array(PITS_PER_SIDE).fill(INITIAL_SEEDS),
        0
      ];
      current = "player";
      ended = false;
      setStatus("Tocca una tua buca per iniziare.");
      render();
    }

    function setStatus(text, winner = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle("winner", winner);
    }

    function pitsOf(side) {
      return side === "player" ? [0, 1, 2, 3, 4, 5] : [7, 8, 9, 10, 11, 12];
    }

    function storeOf(side) {
      return side === "player" ? 6 : 13;
    }

    function oppositeStore(side) {
      return side === "player" ? 13 : 6;
    }

    function oppositePit(i) {
      return 12 - i;
    }

    function isOwnPit(side, idx) {
      return side === "player" ? idx >= 0 && idx <= 5 : idx >= 7 && idx <= 12;
    }

    function sideEmpty(side) {
      return pitsOf(side).every((i) => board[i] === 0);
    }

    function collectRemaining() {
      const playerRest = pitsOf("player").reduce((s, i) => s + board[i], 0);
      const cpuRest = pitsOf("cpu").reduce((s, i) => s + board[i], 0);

      pitsOf("player").forEach((i) => (board[i] = 0));
      pitsOf("cpu").forEach((i) => (board[i] = 0));

      board[6] += playerRest;
      board[13] += cpuRest;
    }

    function legalMoves(side) {
      return pitsOf(side).filter((i) => board[i] > 0);
    }

    function applyMove(index, side) {
      if (ended || current !== side || board[index] === 0) return;

      let seeds = board[index];
      board[index] = 0;
      let i = index;

      while (seeds > 0) {
        i = (i + 1) % 14;
        if (i === oppositeStore(side)) continue;
        board[i] += 1;
        seeds -= 1;
      }

      const ownStore = storeOf(side);
      const extraTurn = i === ownStore;

      if (!extraTurn && isOwnPit(side, i) && board[i] === 1) {
        const opp = oppositePit(i);
        if (board[opp] > 0) {
          board[ownStore] += board[opp] + board[i];
          board[opp] = 0;
          board[i] = 0;
        }
      }

      if (sideEmpty("player") || sideEmpty("cpu")) {
        collectRemaining();
        ended = true;
        const p = board[6];
        const c = board[13];
        if (p > c) setStatus("Partita finita: hai vinto " + p + " a " + c + ".", true);
        else if (c > p) setStatus("Partita finita: vince la CPU " + c + " a " + p + ".", true);
        else setStatus("Partita finita: pareggio " + p + " - " + c + ".", true);
      } else if (extraTurn) {
        setStatus((side === "player" ? "Tu" : "CPU") + ": turno bonus.");
      } else {
        current = side === "player" ? "cpu" : "player";
        setStatus(current === "player" ? "Tocca a te." : "Turno CPU...");
      }

      render();
      maybeCpuTurn();
    }

    function evaluateCpuMove(index) {
      const copy = board.slice();
      let seeds = copy[index];
      copy[index] = 0;
      let i = index;

      while (seeds > 0) {
        i = (i + 1) % 14;
        if (i === 6) continue;
        copy[i] += 1;
        seeds -= 1;
      }

      let score = 0;
      if (i === 13) score += 40;
      if (i >= 7 && i <= 12 && copy[i] === 1 && copy[oppositePit(i)] > 0) {
        score += 20 + copy[oppositePit(i)];
      }
      score += copy[13] - board[13];
      score += Math.random() * 0.4;
      return score;
    }

    function cpuMove() {
      const moves = legalMoves("cpu");
      if (moves.length === 0) return;
      let best = moves[0];
      let bestScore = -Infinity;

      moves.forEach((m) => {
        const s = evaluateCpuMove(m);
        if (s > bestScore) {
          bestScore = s;
          best = m;
        }
      });

      applyMove(best, "cpu");
    }

    function maybeCpuTurn() {
      if (ended) return;
      if (!cpuToggle.checked) return;
      if (current !== "cpu") return;
      setTimeout(cpuMove, 420);
    }

    function pitButton(index, label, active) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "pit" + (active ? " active" : "");
      btn.disabled = ended || board[index] === 0 || (current !== "player") || !(index >= 0 && index <= 5);
      btn.innerHTML = '<span>' + board[index] + '</span><span class="label">' + label + '</span>';
      btn.addEventListener("click", () => applyMove(index, "player"));
      return btn;
    }

    function render() {
      storePlayer.textContent = board[6];
      storeCpu.textContent = board[13];

      rowPlayer.innerHTML = "";
      [0, 1, 2, 3, 4, 5].forEach((idx, n) => {
        rowPlayer.appendChild(pitButton(idx, "P" + (n + 1), current === "player"));
      });

      rowCpu.innerHTML = "";
      [12, 11, 10, 9, 8, 7].forEach((idx, n) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "pit" + (current === "cpu" ? " active" : "");
        btn.disabled = true;
        btn.innerHTML = '<span>' + board[idx] + '</span><span class="label">C' + (n + 1) + '</span>';
        rowCpu.appendChild(btn);
      });
    }

    newGameBtn.addEventListener("click", resetBoard);
    cpuToggle.addEventListener("change", () => {
      if (!ended && current === "cpu") maybeCpuTurn();
    });

    resetBoard();
  </script>
</body>
</html>
